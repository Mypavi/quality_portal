<mvc:View controllerName="quality.controller.ResultRecording"
    xmlns:mvc="sap.ui.core.mvc" displayBlock="true"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:core="sap.ui.core"
    xmlns:layout="sap.ui.layout">
    
    <Page id="resultPage" title="Result Recording" showNavButton="true" navButtonPress="onNavBack" 
          class="resultRecordingPage" busy="{viewModel>/busy}">
        
        <!-- Custom Header with Gradient Background -->
        <customHeader>
            <Bar class="customHeaderBar">
                <contentLeft>
                    <Button icon="sap-icon://nav-back" press="onNavBack" type="Transparent" />
                </contentLeft>
                <contentMiddle>
                    <Title text="Quality Result Recording" class="headerTitle" />
                </contentMiddle>
                <contentRight>
                    <Button icon="sap-icon://refresh" press="onRefreshData" type="Transparent" tooltip="Refresh Data" />
                </contentRight>
            </Bar>
        </customHeader>

        <content>
            <!-- Hero Section with Lot Information -->
            <Panel class="heroPanel" visible="{= !!${inspection>InspectionLotNumber} }">
                <content>
                    <layout:Grid defaultSpan="L12 M12 S12" class="heroGrid">
                        <layout:content>
                            <!-- Lot Information Card -->
                            <f:Card class="lotInfoCard">
                                <f:header>
                                    <f:Header title="Inspection Lot {inspection>InspectionLotNumber}" 
                                             subtitle="{inspection>PlantDescription} ({inspection>Plant})" />
                                </f:header>
                                <f:content>
                                    <VBox class="cardContent">
                                        <HBox justifyContent="SpaceBetween" alignItems="Center" class="sapUiSmallMarginBottom">
                                            <VBox>
                                                <Label text="Material" class="cardLabel" />
                                                <Text text="{inspection>SelectedMaterial}" class="cardValue" />
                                            </VBox>
                                            <VBox>
                                                <Label text="Lot Quantity" class="cardLabel" />
                                                <Text text="{inspection>ActualQuantity} {inspection>UnitOfMeasure}" class="cardValue" />
                                            </VBox>
                                            <VBox>
                                                <Label text="Inspected" class="cardLabel" />
                                                <Text text="{inspection>InspectedQuantity} {inspection>UnitOfMeasure}" class="cardValue" />
                                            </VBox>
                                        </HBox>
                                        
                                        <!-- Progress Bar -->
                                        <VBox class="sapUiSmallMarginTop">
                                            <Label text="Inspection Progress" class="cardLabel" />
                                            <ProgressIndicator 
                                                percentValue="{= (${inspection>InspectedQuantity} / ${inspection>ActualQuantity}) * 100 }"
                                                displayValue="{= Math.round((${inspection>InspectedQuantity} / ${inspection>ActualQuantity}) * 100) }%"
                                                state="{= (${inspection>InspectedQuantity} / ${inspection>ActualQuantity}) >= 1 ? 'Success' : 'Information' }"
                                                class="progressBar" />
                                        </VBox>

                                        <!-- Status Badge -->
                                        <HBox justifyContent="End" class="sapUiSmallMarginTop">
                                            <ObjectStatus 
                                                text="{path: 'inspection>UsageDecisionCode', formatter: '.formatUDText'}"
                                                state="{path: 'inspection>UsageDecisionCode', formatter: '.formatUDState'}"
                                                icon="{= ${inspection>UsageDecisionCode} === 'A' ? 'sap-icon://accept' : ${inspection>UsageDecisionCode} === 'R' ? 'sap-icon://decline' : 'sap-icon://pending' }"
                                                class="statusBadge" />
                                        </HBox>
                                    </VBox>
                                </f:content>
                            </f:Card>
                        </layout:content>
                    </layout:Grid>
                </content>
            </Panel>

            <!-- Quick Actions Panel -->
            <Panel class="actionsPanel" visible="{= !!${inspection>InspectionLotNumber} }">
                <headerToolbar>
                    <Toolbar class="actionToolbar">
                        <Title text="Quick Actions" level="H3" class="actionTitle" />
                    </Toolbar>
                </headerToolbar>
                <content>
                    <HBox justifyContent="Center" alignItems="Center" wrap="Wrap" class="actionButtons">
                        <!-- Accept Button -->
                        <Button text="Accept Lot" 
                                type="Accept" 
                                press="onAcceptPress" 
                                icon="sap-icon://accept"
                                class="actionButton acceptButton"
                                visible="{= !${inspection>UsageDecisionCode} }" />
                        
                        <!-- Reject Button -->
                        <Button text="Reject Lot" 
                                type="Reject" 
                                press="onRejectPress" 
                                icon="sap-icon://decline"
                                class="actionButton rejectButton"
                                visible="{= !${inspection>UsageDecisionCode} }" />
                        
                        <!-- Usage Decision Button -->
                        <Button text="Usage Decision" 
                                type="Emphasized" 
                                press="onProceedToUsageDecision" 
                                icon="sap-icon://decision"
                                class="actionButton usageButton" />
                        
                        <!-- Refresh Data Button -->
                        <Button text="Refresh Data" 
                                type="Transparent" 
                                press="onRefreshData" 
                                icon="sap-icon://refresh"
                                class="actionButton refreshButton" />
                        
                        <!-- Test Data Fetch Button (Debug) -->
                        <Button text="Test Fetch" 
                                type="Ghost" 
                                press="onTestDataFetch" 
                                icon="sap-icon://test-automation"
                                class="actionButton testButton"
                                visible="true" />
                    </HBox>
                </content>
            </Panel>

            <!-- Result Entry Form -->
            <Panel class="entryPanel" 
                   visible="{= !!${inspection>InspectionLotNumber} &amp;&amp; !${inspection>UsageDecisionCode} }"
                   expandable="true" 
                   expanded="true">
                <headerToolbar>
                    <Toolbar class="entryToolbar">
                        <Title text="Record Quality Results" level="H3" class="entryTitle" />
                        <ToolbarSpacer />
                        <Label text="Daily Entry" class="entrySubtitle" />
                    </Toolbar>
                </headerToolbar>
                <content>
                    <VBox class="entryForm">
                        <!-- Input Fields -->
                        <layout:Grid defaultSpan="L4 M6 S12" class="inputGrid">
                            <layout:content>
                                <!-- Unrestricted Stock -->
                                <VBox class="inputGroup unrestrictedGroup">
                                    <Label text="Unrestricted Stock" class="inputLabel" />
                                    <Text text="(Good Quality)" class="inputDescription" />
                                    <Input id="inputUnrestricted" 
                                           placeholder="Enter quantity" 
                                           type="Number" 
                                           class="inputField unrestrictedInput"
                                           liveChange="onInputChange" />
                                </VBox>
                                
                                <!-- Blocked Stock -->
                                <VBox class="inputGroup blockedGroup">
                                    <Label text="Blocked Stock" class="inputLabel" />
                                    <Text text="(Defective)" class="inputDescription" />
                                    <Input id="inputBlocked" 
                                           placeholder="Enter quantity" 
                                           type="Number" 
                                           class="inputField blockedInput"
                                           liveChange="onInputChange" />
                                </VBox>
                                
                                <!-- Production Stock -->
                                <VBox class="inputGroup productionGroup">
                                    <Label text="Production Stock" class="inputLabel" />
                                    <Text text="(Rework Required)" class="inputDescription" />
                                    <Input id="inputProduction" 
                                           placeholder="Enter quantity" 
                                           type="Number" 
                                           class="inputField productionInput"
                                           liveChange="onInputChange" />
                                </VBox>
                            </layout:content>
                        </layout:Grid>
                        
                        <!-- Save Button -->
                        <HBox justifyContent="Center" class="sapUiMediumMarginTop">
                            <Button text="Save Results" 
                                    type="Emphasized" 
                                    icon="sap-icon://save" 
                                    press="onSaveResult" 
                                    class="saveButton" />
                        </HBox>
                        
                        <!-- Help Text -->
                        <MessageStrip text="Enter only the quantities processed in the current session. All entries are cumulative." 
                                     type="Information" 
                                     class="helpMessage sapUiSmallMarginTop" />
                    </VBox>
                </content>
            </Panel>

            <!-- Results History -->
            <Panel class="historyPanel" expandable="true" expanded="true">
                <headerToolbar>
                    <Toolbar class="historyToolbar">
                        <Title text="Recording History" level="H3" class="historyTitle" />
                        <ToolbarSpacer />
                        <Text text="{viewModel>/resultCount} Records" class="recordCount" />
                        <SearchField search="onSearch" 
                                   width="250px" 
                                   placeholder="Search by lot number..." 
                                   class="searchField" />
                    </Toolbar>
                </headerToolbar>
                <content>
                    <!-- No Data Message -->
                    <MessagePage title="No Results Found" 
                                description="No quality results have been recorded yet. Start by recording results for an inspection lot."
                                icon="sap-icon://document"
                                visible="{= !${viewModel>/hasData} &amp;&amp; !${viewModel>/busy} }"
                                class="noDataMessage">
                        <customDescription>
                            <Button text="Refresh Data" 
                                    type="Emphasized" 
                                    press="onRefreshData" 
                                    icon="sap-icon://refresh" />
                        </customDescription>
                    </MessagePage>

                    <!-- Results Table -->
                    <Table id="resultTable" 
                           items="{result>/ZQM_RESULT_PR}" 
                           growing="true" 
                           growingThreshold="20"
                           visible="{viewModel>/hasData}"
                           class="resultsTable">
                        <columns>
                            <Column width="12rem">
                                <Text text="Inspection Lot" class="columnHeader" />
                            </Column>
                            <Column width="8rem" minScreenWidth="Tablet" demandPopin="true">
                                <Text text="Plant" class="columnHeader" />
                            </Column>
                            <Column width="10rem" minScreenWidth="Tablet" demandPopin="true">
                                <Text text="Inspector" class="columnHeader" />
                            </Column>
                            <Column width="10rem">
                                <Text text="Date" class="columnHeader" />
                            </Column>
                            <Column width="12rem">
                                <Text text="Category" class="columnHeader" />
                            </Column>
                            <Column width="8rem" hAlign="End">
                                <Text text="Quantity" class="columnHeader" />
                            </Column>
                            <Column width="10rem">
                                <Text text="Status" class="columnHeader" />
                            </Column>
                        </columns>
                        <items>
                            <ColumnListItem class="resultRow" press="onResultPress">
                                <cells>
                                    <ObjectIdentifier title="{result>InspectionLotNumber}" 
                                                    class="lotIdentifier" />
                                    <Text text="{result>PlantCode}" class="cellText" />
                                    <Text text="{result>InspectorName}" class="cellText" />
                                    <Text text="{path: 'result>RecordedDate', type: 'sap.ui.model.type.Date', formatOptions: { style: 'medium' }}" 
                                          class="cellText" />
                                    <ObjectStatus text="{result>ResultCategory}" 
                                                state="{path: 'result>ResultCategory', formatter: '.formatCategoryState'}"
                                                class="categoryStatus" />
                                    <ObjectNumber number="{result>StockCode}" 
                                                class="quantityNumber" />
                                    <ObjectStatus text="{path: 'result>UsageDecisionCode', formatter: '.formatUDText'}"
                                                state="{path: 'result>UsageDecisionCode', formatter: '.formatUDState'}"
                                                icon="{= ${result>UsageDecisionCode} ? 'sap-icon://accept' : 'sap-icon://pending' }"
                                                class="statusIndicator" />
                                </cells>
                            </ColumnListItem>
                        </items>
                    </Table>
                </content>
            </Panel>
        </content>
    </Page>
</mvc:View>
